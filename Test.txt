import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.audit.api.AuditService
import java.time.ZoneId

/**
 * Gibt das Datum zurÃ¼ck, an dem der Nutzer zuletzt deaktiviert wurde, oder null falls nicht gefunden.
 *
 * @param username der Nutzername des betroffenen Nutzers
 * @return Date der letzten Deaktivierung oder null
 */
Date getLastDeactivationDate(String username) {
    def auditService = ComponentAccessor.getOSGiComponentInstanceOfType(AuditService)

    def records = auditService.getRecords(0, 1000).findAll { record ->
        record.action == "User deactivated" &&
        record.affectedObjects.any { it.name == username }
    }.sort { -it.created.toEpochMilli() }

    if (records) {
        def lastDeactivation = records.first()
        return Date.from(lastDeactivation.created.atZone(ZoneId.systemDefault()).toInstant())
    }

    return null
}
