import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.audit.api.AuditSearchService
import com.atlassian.audit.api.AuditQuery
import java.time.ZoneId

/**
 * Liefert das Datum der letzten Deaktivierung des Nutzers anhand AuditSearchService.
 *
 * @param username Nutzername des Jira-Nutzers
 * @return Date der letzten Deaktivierung oder null
 */
Date getLastDeactivationDate(String username) {
    def auditSearchService = ComponentAccessor.getOSGiComponentInstanceOfType(AuditSearchService)

    def query = AuditQuery.builder()
        .actions("User deactivated")
        .affectedObject(username)
        .maxResults(1)
        .build()

    def results = auditSearchService.getRecords(query)

    if (results && results.records) {
        return Date.from(results.records.first().created.atZone(ZoneId.systemDefault()).toInstant())
    }

    return null
}
